<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Reminders - SHRS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .rem-card {
      border-radius: 18px;
      transition: 0.3s;
    }
    .rem-card:hover {
      transform: translateY(-5px);
      box-shadow: 0px 6px 15px rgba(0,0,0,0.1);
    }
  </style>
</head>

<body class="bg-light">
  <!-- Optional: drop an alarm audio file into your static files and set its src here -->
  <audio id="alarmSound" style="display:none"></audio>
<div class="container mt-3">
    <a href="{% url 'dashboard' %}" class="btn btn-secondary">Back</a>
</div>
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-primary px-3">
    <span class="navbar-brand fs-4 fw-bold">SHRS</span>
  </nav>

  <div class="container py-4">

    <!-- Debug info: shows last fetch time and number of reminders returned -->
    <div id="notificationDebug" class="container mb-3" style="display:none">
      <div class="alert alert-info">Last check: <span id="lastCheck">never</span> — Found <span id="lastCount">0</span> reminders</div>
    </div>
    <div id="notificationStatus" class="container mb-3">
      <div class="alert alert-secondary">Notification support: <strong id="notifSupport">checking...</strong> — Permission: <strong id="notifPerm">unknown</strong> — Secure context: <strong id="secureCtx">?</strong></div>
    </div>
    <!-- In-page modal popup for reminders -->
    <div class="modal fade" id="reminderModal" tabindex="-1" aria-labelledby="reminderModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="reminderModalLabel">Reminder</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="reminderModalText"></p>
            <p class="text-muted"><small id="reminderModalTime"></small></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="fw-semibold">Your Reminders</h3>
      <div>
        <button id="enableAlerts" class="btn btn-outline-primary me-2">Enable Sound & Notifications</button>
        <button id="testAlert" class="btn btn-outline-success me-2">Test Alert</button>
        <button id="debugFetch" class="btn btn-outline-secondary me-2">Debug Fetch</button>
        <a href="{% url 'reminder' %}" class="btn btn-success px-3">+ Add New</a>
      </div>
    </div>

    <!-- Reminder Cards -->
    <div class="row g-3">
      {% for reminder in reminders %}
      <div class="col-lg-4 col-md-6">
        <div class="card rem-card shadow-sm p-3">
          <div class="d-flex justify-content-between align-items-start">
            <h5 class="fw-bold">{{ reminder.medicine_name }}</h5>
            <span class="badge bg-primary">{{ reminder.dosage }}</span>
          </div>
          <p class="text-muted mt-2 mb-1">Member: {{ reminder.member.name }}</p>
          <p class="mb-1"><strong>Time:</strong> {{ reminder.time }}</p>
          <p class="mb-3"><strong>Date:</strong> {{ reminder.date }}</p>

          <div class="d-flex justify-content-end gap-2">
            <a href="{% url 'editReminder' reminder.id %}" class="btn btn-warning btn-sm">Edit</a>
            <a href="{% url 'deleteReminder' reminder.id %}" class="btn btn-danger btn-sm">Delete</a>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="col-12">
        <p class="text-muted">No reminders found. Add one from Add New.</p>
      </div>
      {% endfor %}
    </div>
  </div>
          
    <script>
    // Poll server for upcoming reminders, show browser notifications and play a short beep.
    (function(){
      const pollInterval = 30000; // 30 sec

      // WebAudio setup (will be resumed on user gesture)
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const audioCtx = AudioCtx ? new AudioCtx() : null;
      let audioUnlocked = false;
      // optional audio element (if you place an audio file in static and set its src)
      const audioElem = document.getElementById('alarmSound');

      function playBeep(){
        if(!audioCtx) return;
        try{
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = 'sine';
          o.frequency.value = 880; // A5 beep
          g.gain.value = 0.12;
          o.connect(g);
          g.connect(audioCtx.destination);
          const now = audioCtx.currentTime;
          o.start(now);
          g.gain.exponentialRampToValueAtTime(0.0001, now + 0.8);
          o.stop(now + 0.85);
        }catch(e){
          console.warn('beep failed', e);
        }
      }

      function playSoundFallback(){
        // prefer an audio element if present and has a source
        if(audioElem && audioElem.src){
          try{ audioElem.currentTime = 0; audioElem.play(); return; }catch(e){ /* fallback */ }
        }
        // else use WebAudio beep
        if(audioCtx && !audioUnlocked){
          audioCtx.resume().then(()=>{ audioUnlocked = true; playBeep(); }).catch(()=>{ playBeep(); });
        } else {
          playBeep();
        }
      }

      function requestPermission(){
        if ("Notification" in window && Notification.permission !== 'granted'){
          Notification.requestPermission();
        }
      }

      function updateStatus(){
        const supportEl = document.getElementById('notifSupport');
        const permEl = document.getElementById('notifPerm');
        const secureEl = document.getElementById('secureCtx');
        if(supportEl) supportEl.textContent = ("Notification" in window) ? 'yes' : 'no';
        if(permEl) permEl.textContent = ("Notification" in window) ? Notification.permission : 'n/a';
        if(secureEl) secureEl.textContent = (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'yes' : 'no';
      }

      // update UI status initially and after permission changes
      updateStatus();

      async function fetchUpcoming(debug=false){
        try{
          const url = '{% url "api_upcoming_reminders" %}' + (debug ? '?debug=1' : '');
          const resp = await fetch(url, {credentials: 'same-origin'});
          if(!resp.ok) return;
          const data = await resp.json();
          if(!data.reminders) return;
              console.log('upcoming fetch status', resp.status);
              console.log('upcoming data', data);
              document.getElementById('notificationDebug').style.display = 'block';
              document.getElementById('lastCheck').textContent = new Date().toLocaleString();
              document.getElementById('lastCount').textContent = (data.reminders || []).length;
              (data.reminders || []).forEach(async (r) => {
            // show browser notification
            if ("Notification" in window){
              if(Notification.permission === 'granted'){
                try{
                  const n = new Notification(r.title, { body: r.dosage || '', tag: 'rem-'+r.id });
                  // attach handlers to observe behavior
                  n.onshow = () => console.log('Notification shown for', r.id);
                  n.onerror = (e) => console.error('Notification error', e, r.id);
                  n.onclick = () => { console.log('Notification clicked', r.id); window.focus(); };
                }catch(e){
                  console.error('creating Notification failed', e);
                }
              } else if(Notification.permission === 'denied'){
                console.warn('Notification permission denied — please enable in browser settings');
                // show an in-page hint to the user
                const status = document.getElementById('notificationStatus');
                if(status){
                  status.innerHTML = '<div class="alert alert-warning">Notifications are <strong>blocked</strong> in your browser. Enable them in site settings (click the lock icon in the address bar).</div>';
                }
              } else {
                // not granted yet — request in response to user gesture if possible
                try{ await Notification.requestPermission(); updateStatus(); }catch(e){ console.warn('requestPermission failed', e); }
              }
            } else {
              console.warn('Notifications API not supported in this browser');
            }

            // in-page popup: if the server marked this reminder in-window, show modal alert
            try{
              if(r.in_window){
                const modalTitle = document.getElementById('reminderModalLabel');
                const modalText = document.getElementById('reminderModalText');
                const modalTime = document.getElementById('reminderModalTime');
                if(modalTitle && modalText){
                  modalTitle.textContent = r.title || 'Reminder';
                  modalText.textContent = r.dosage || '';
                  modalTime.textContent = (r.datetime ? new Date(r.datetime).toLocaleString() : '');
                  // show bootstrap modal
                  try{
                    var remModal = new bootstrap.Modal(document.getElementById('reminderModal'));
                    remModal.show();
                  }catch(e){
                    // fallback to simple alert
                    alert((r.title || 'Reminder') + '\n' + (r.dosage || ''));
                  }
                }
              }
            }catch(e){ console.warn('popup error', e); }

            // try to play sound: prefer audio element then WebAudio beep
            playSoundFallback();

            // mark as notified so it doesn't repeat
            try{
              if(r.in_window || !debug){
                fetch('{% url "api_mark_notified" 0 %}'.replace('/0/', '/'+r.id+'/'), {method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}, credentials: 'same-origin'});
              }
            }catch(e){ console.warn('mark-notified failed', e); }
          });
          if(debug){
            document.getElementById('debugOutput').style.display = 'block';
            document.getElementById('debugJSON').textContent = JSON.stringify(data, null, 2);
          }
        }catch(e){
          console.error('upcoming fetch error', e);
        }
      }

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      // Unlock audio & request notification permission on button click (user gesture)
      const enableBtn = document.getElementById('enableAlerts');
      if(enableBtn){
        enableBtn.addEventListener('click', async function(){
          if(audioCtx){
            try{
              await audioCtx.resume();
              audioUnlocked = true;
            }catch(e){
              console.warn('audio resume failed', e);
            }
          }
          if ("Notification" in window) await Notification.requestPermission();
          updateStatus();
          // give immediate feedback
          enableBtn.textContent = 'Alerts Enabled';
          enableBtn.disabled = true;
        });
      }

      // Test alert button to immediately show a notification + sound (useful to verify permissions)
      const testBtn = document.getElementById('testAlert');
      if(testBtn){
        testBtn.addEventListener('click', async function(){
          if ("Notification" in window && Notification.permission !== 'granted'){
            await Notification.requestPermission();
          }
          if ("Notification" in window && Notification.permission === 'granted'){
            new Notification('Test Reminder', { body: 'This is a test alarm.' });
          }
          playSoundFallback();
          // visual feedback
          testBtn.textContent = 'Test Sent';
          setTimeout(()=>{ testBtn.textContent = 'Test Alert'; }, 1500);
        });
      }

      // Debug fetch button: hits the endpoint with debug=1 and prints JSON
      const debugBtn = document.getElementById('debugFetch');
      if(debugBtn){
        debugBtn.addEventListener('click', async function(){
          debugBtn.textContent = 'Fetching...';
          await fetchUpcoming(true);
          debugBtn.textContent = 'Debug Fetch';
        });
      }

      // start
      requestPermission();
      fetchUpcoming();
      setInterval(fetchUpcoming, pollInterval);
    })();
    </script>

    </body>
    </html>
