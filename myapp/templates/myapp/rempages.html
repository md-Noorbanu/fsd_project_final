<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Reminders - SHRS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .rem-card {
      border-radius: 18px;
      transition: 0.3s;
    }
    .rem-card:hover {
      transform: translateY(-5px);
      box-shadow: 0px 6px 15px rgba(0,0,0,0.1);
    }
  </style>
</head>

<body class="bg-light">
  <!-- Optional: set src to an alarm sound in your static files -->
  <audio id="alarmSound" style="display:none"></audio>

  <div class="container mt-3">
    <a href="{% url 'dashboard' %}" class="btn btn-secondary">Back</a>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-primary px-3">
    <span class="navbar-brand fs-4 fw-bold">SHRS</span>
  </nav>

  <div class="container py-4">

    <!-- ensure CSRF cookie is set for AJAX posts -->
    <form id="csrfHelper" style="display:none">{% csrf_token %}</form>

    <!-- Debug info: shows last fetch time and number of reminders returned -->
    <div id="notificationDebug" class="container mb-3" style="display:none">
      <div class="alert alert-info">
        Last check: <span id="lastCheck">never</span> — Found <span id="lastCount">0</span> reminders
      </div>
      <pre id="rawDebug" class="bg-light p-2" style="max-height:240px; overflow:auto; display:none"></pre>
    </div>

    <div id="notificationStatus" class="container mb-3">
      <div class="alert alert-secondary">
        Notification support: <strong id="notifSupport">checking...</strong> —
        Permission: <strong id="notifPerm">unknown</strong> —
        Secure context: <strong id="secureCtx">?</strong>
      </div>
    </div>

    <!-- In-page modal popup for reminders -->
    <div class="modal fade" id="reminderModal" tabindex="-1" aria-labelledby="reminderModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="reminderModalLabel">Reminder</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="reminderModalText"></p>
            <p class="text-muted"><small id="reminderModalTime"></small></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="fw-semibold">Your Reminders</h3>
      <div>
        <button id="enableAlerts" class="btn btn-outline-primary me-2">Enable Sound & Notifications</button>
        <button id="testAlert" class="btn btn-outline-success me-2">Test Alert</button>
        <button id="forceCheck" class="btn btn-outline-secondary me-2">Force Check</button>
        <a href="{% url 'reminder' %}" class="btn btn-success px-3">+ Add New</a>
      </div>
    </div>

    <!-- Reminder Cards -->
    <div class="row g-3">
      {% for reminder in reminders %}
      <div class="col-lg-4 col-md-6">
        <div class="card rem-card shadow-sm p-3">
          <div class="d-flex justify-content-between align-items-start">
            <h5 class="fw-bold">{{ reminder.medicine_name }}</h5>
            <span class="badge bg-primary">{{ reminder.dosage }}</span>
          </div>
          <p class="text-muted mt-2 mb-1">Member: {{ reminder.member.name }}</p>
          <p class="mb-1"><strong>Time:</strong> {{ reminder.time }}</p>
          <p class="mb-3"><strong>Date:</strong> {{ reminder.date }}</p>

          <div class="d-flex justify-content-end gap-2">
            <a href="{% url 'editReminder' reminder.id %}" class="btn btn-warning btn-sm">Edit</a>
            <a href="{% url 'deleteReminder' reminder.id %}" class="btn btn-danger btn-sm">Delete</a>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="col-12">
        <p class="text-muted">No reminders found. Add one from Add New.</p>
      </div>
      {% endfor %}
    </div>
  </div>

  <script>
(function(){
  const pollInterval = 10000; // 10 sec

  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const audioCtx = AudioCtx ? new AudioCtx() : null;
  let audioUnlocked = false;
  const audioElem = document.getElementById('alarmSound');

  // track notified IDs on this device
  const notifiedKey = 'shrs_notified_ids_v1';
  let notifiedIds = new Set();
  try {
    const raw = localStorage.getItem(notifiedKey);
    if (raw) JSON.parse(raw).forEach(id => notifiedIds.add(String(id)));
  } catch(e){ console.warn('load notified ids', e); }

  function persistNotified(){
    try {
      localStorage.setItem(notifiedKey, JSON.stringify(Array.from(notifiedIds)));
    } catch(e){}
  }

  function parseRemDate(r){
    if (r.datetime) {
      let s = String(r.datetime).trim();

      // numeric timestamp (ms)
      if (/^\d+$/.test(s)) {
        const d = new Date(parseInt(s, 10));
        return isNaN(d) ? null : d;
      }

      // If format 'YYYY-MM-DD HH:MM:SS' (no timezone), convert to ISO and append IST offset
      if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(s)) {
        s = s.replace(' ', 'T') + '+05:30';
      } else if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/.test(s)) {
        // naive T format w/o offset — treat as server local (IST)
        s = s + '+05:30';
      }
      const d = new Date(s);
      return isNaN(d) ? null : d;
    }
    return null;
  }

  function playBeep(){
    if (!audioCtx) return;
    try {
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.value = 880;
      g.gain.value = 0.12;
      o.connect(g);
      g.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      o.start(now);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.8);
      o.stop(now + 0.85);
    } catch(e){ console.warn('beep failed', e); }
  }

  function playSoundFallback(){
    if (audioElem && audioElem.src){
      try {
        audioElem.currentTime = 0;
        audioElem.play();
        return;
      } catch(e){}
    }
    if (audioCtx && !audioUnlocked){
      audioCtx.resume().then(()=>{
        audioUnlocked = true;
        playBeep();
      }).catch(()=>{
        playBeep();
      });
    } else {
      playBeep();
    }
  }

  function updateStatus(msg){
    const supportEl = document.getElementById('notifSupport');
    const permEl = document.getElementById('notifPerm');
    const secureEl = document.getElementById('secureCtx');
    const statusContainer = document.getElementById('notificationStatus');

    if (supportEl) supportEl.textContent = ("Notification" in window) ? 'yes' : 'no';
    if (permEl) permEl.textContent = ("Notification" in window) ? Notification.permission : 'n/a';
    if (secureEl) secureEl.textContent =
      (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1')
        ? 'yes' : 'no';

    if (msg && statusContainer){
      statusContainer.innerHTML = '<div class="alert alert-info">'+msg+'</div>';
    }

    if (statusContainer && secureEl && secureEl.textContent === 'no'){
      statusContainer.innerHTML =
        '<div class="alert alert-warning">This page is not in a secure context. ' +
        'Browser notifications typically require HTTPS or localhost. Notifications may not work.</div>';
    }
  }

  // unlock audio on first click
  (function setupOneClickUnlock(){
    async function oneClickHandler(){
      if (audioCtx){
        try {
          await audioCtx.resume();
          audioUnlocked = true;
        } catch(e){}
      }
      document.removeEventListener('click', oneClickHandler);
    }
    document.addEventListener('click', oneClickHandler, {once: true});
  })();

  updateStatus();

  async function fetchUpcoming(debug=false){
    try{
      const url = '{% url "api_upcoming_reminders" %}' + (debug ? '?debug=1' : '');
      const resp = await fetch(url, {
        credentials: 'same-origin',
        cache: 'no-store',
        headers: { 'Accept': 'application/json' }
      });

      if (!resp.ok){
        const status = document.getElementById('notificationStatus');
        if (status) status.innerHTML = '<div class="alert alert-danger">Fetch error: '+resp.status+'</div>';
        console.error('fetchUpcoming non-ok', resp.status);
        return;
      }

      const data = await resp.json();
      const reminders = Array.isArray(data) ? data :
                        (Array.isArray(data.reminders) ? data.reminders : []);

      try { document.getElementById('notificationDebug').style.display = 'block'; } catch(e){}
      try { document.getElementById('lastCheck').textContent = new Date().toLocaleString(); } catch(e){}
      try { document.getElementById('lastCount').textContent = reminders.length; } catch(e){}

      const rawDebug = document.getElementById('rawDebug');
      if (rawDebug){
        rawDebug.style.display = (debug || reminders.length === 0) ? 'block' : 'none';
        rawDebug.textContent = JSON.stringify(data, null, 2);
      }

      if (reminders.length === 0) return;

      reminders.forEach(async (r) => {
        const id = String(r.id || r.pk || r.reminder_id || r._id || Math.random());

        // backend already filtered to "due now", so everything returned is in window
        const scheduledDate = parseRemDate(r);

        if (notifiedIds.has(id)){
          // best-effort: mark notified on server
          try{
            const markUrl = '{% url "api_mark_notified" 999 %}'.replace('999', id);
            fetch(markUrl, {
              method: 'POST',
              headers: { 'X-CSRFToken': getCookie('csrftoken') },
              credentials: 'same-origin'
            });
          } catch(e){}
          return;
        }

        // show browser notification if allowed
        let notifiedViaBrowser = false;
        if ("Notification" in window && Notification.permission === 'granted'){
          try{
            const n = new Notification(
              r.title || 'Reminder',
              { body: r.dosage || '', tag: 'rem-'+id }
            );
            n.onclick = () => { window.focus(); };
            notifiedViaBrowser = true;
          } catch(e){
            console.error('Notification creation failed', e);
            updateStatus('Notification creation failed: ' + (e && e.message ? e.message : e));
          }
        }

        // fallback: modal
        if (!notifiedViaBrowser){
          try{
            const modalTitle = document.getElementById('reminderModalLabel');
            const modalText = document.getElementById('reminderModalText');
            const modalTime = document.getElementById('reminderModalTime');
            if (modalTitle && modalText){
              modalTitle.textContent = r.title || 'Reminder';
              modalText.textContent = r.dosage || '';
              modalTime.textContent = (scheduledDate ? scheduledDate.toLocaleString() : '');
              var remModal = new bootstrap.Modal(document.getElementById('reminderModal'));
              remModal.show();
            }
          } catch(e){
            console.warn('popup error', e);
            alert((r.title || 'Reminder') + '\n' + (r.dosage || ''));
          }
        }

        playSoundFallback();

        notifiedIds.add(id);
        persistNotified();

        try{
          const markUrl = '{% url "api_mark_notified" 999 %}'.replace('999', id);
          fetch(markUrl, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            credentials: 'same-origin'
          });
        } catch(e){ console.warn('mark-notified failed', e); }
      });

    } catch(e){
      console.error('upcoming fetch error', e);
    }
  }

  // Force-check button
  const forceBtn = document.getElementById('forceCheck');
  if (forceBtn){
    forceBtn.addEventListener('click', async function(){
      forceBtn.textContent = 'Checking...';
      try{
        await fetchUpcoming(true);
      } finally{
        setTimeout(()=>{ forceBtn.textContent = 'Force Check'; }, 1200);
      }
    });
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  // Enable alerts button
  const enableBtn = document.getElementById('enableAlerts');
  if (enableBtn){
    enableBtn.addEventListener('click', async function(){
      if (audioCtx){
        try{
          await audioCtx.resume();
          audioUnlocked = true;
        } catch(e){ console.warn('audio resume failed', e); }
      }
      if (!("Notification" in window)){
        updateStatus('This browser does not support notifications.');
      } else {
        try{
          const perm = await Notification.requestPermission();
          updateStatus();
          if (perm === 'granted'){
            try{
              new Notification('SHRS: Notifications enabled', { body: 'You will receive reminders.' });
              updateStatus('Notifications enabled.');
            } catch(e){
              console.error('Immediate test notification failed', e);
              updateStatus('Notification granted but creation failed — maybe insecure context or blocked.');
            }
            enableBtn.textContent = 'Alerts Enabled';
            enableBtn.disabled = true;
          } else if (perm === 'denied') {
            updateStatus('Notifications denied. Enable them in browser site settings if you want them.');
          } else {
            updateStatus('Notification permission not granted yet.');
          }
        } catch(e){
          console.warn('requestPermission failed', e);
          updateStatus('Unable to request notification permission: ' + (e && e.message ? e.message : e));
        }
      }
    });
  }

  // Test Alert button
  const testBtn = document.getElementById('testAlert');
  if (testBtn){
    testBtn.addEventListener('click', async function(){
      if ("Notification" in window && Notification.permission !== 'granted'){
        await Notification.requestPermission();
        updateStatus();
      }
      if ("Notification" in window && Notification.permission === 'granted'){
        try{
          new Notification('Test Reminder', { body: 'This is a test alarm.' });
        } catch(e){
          updateStatus('Test notification failed: '+ (e && e.message ? e.message : e));
        }
      } else {
        try{
          var remModal = new bootstrap.Modal(document.getElementById('reminderModal'));
          document.getElementById('reminderModalLabel').textContent = 'Test Reminder';
          document.getElementById('reminderModalText').textContent = 'This is a test alarm.';
          document.getElementById('reminderModalTime').textContent = new Date().toLocaleString();
          remModal.show();
        } catch(e){}
      }
      playSoundFallback();
      testBtn.textContent = 'Test Sent';
      setTimeout(()=>{ testBtn.textContent = 'Test Alert'; }, 1500);
    });
  }

  // start polling
  fetchUpcoming();
  setInterval(fetchUpcoming, pollInterval);
})();
</script>

</body>
</html>